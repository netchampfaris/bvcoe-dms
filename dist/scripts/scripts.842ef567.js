"use strict";angular.module("bvcoeDmsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","cgBusy","ngStorage"]).run(["$rootScope","FirebaseRef","FirebaseAuth","$location","$localStorage",function(a,b,c,d,e){a.$storage=e,a.$storage.authData=b.getAuth(),b.onAuth(function(c){c?(console.log("Logged in as:",c.uid),d.path("/dashboard")):console.log("Logged out"),a.$storage.authData=b.getAuth()}),a.logout=function(){b.unauth(),delete a.$storage.authData,delete a.$storage.userData}}]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main",resolve:{currentAuth:["FirebaseAuth",function(a){return a.$waitForAuth()}]}}).when("/dashboard",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl",controllerAs:"dashboard",resolve:{currentAuth:["FirebaseAuth",function(a){return a.$requireAuth()}]}}).when("/defaulters",{templateUrl:"views/defaulters.html",controller:"DefaultersCtrl",controllerAs:"defaulters"}).when("/dataentry",{templateUrl:"views/dataentry.html",controller:"DataentryCtrl",controllerAs:"dataentry",resolve:{currentAuth:["FirebaseAuth",function(a){return a.$requireAuth()}]}}).when("/attendances",{templateUrl:"views/attendances.html",controller:"AttendancesCtrl",controllerAs:"attendances"}).when("/genDefaulter",{templateUrl:"views/gendefaulter.html",controller:"GendefaulterCtrl",controllerAs:"genDefaulter"}).when("/takeAttendance",{templateUrl:"views/takeAttendance.html",controller:"TakeAttendanceCtrl",controllerAs:"takeAttendance"}).otherwise({redirectTo:"/"})}]),angular.module("bvcoeDmsApp").controller("MainCtrl",["FirebaseRef","$scope","$location","$rootScope","$q","isNewUser",function(a,b,c,d,e,f){d.$storage.authData=a.getAuth(),b.depts=[],a.onAuth(function(e){e?f(e).then(function(f){console.log("new user: "+f),f?a.child("teachers/"+e.uid).set({dept:b.reg.dept,name:b.reg.name,role:b.reg.teacherrole},function(){h&&a.child("tokens/"+h).remove(function(){console.log("token removed "+h)})}):a.child("teachers/"+e.uid).once("value",function(a){d.$storage.userData=a.val(),d.$apply()}),console.log("Logged in as:",e.uid),c.path("/attendances")},function(){}):console.log("Logged out")}),b.login={},b.login.message="",b.login.success=!0,b.login=function(c){var d=e.defer();a.authWithPassword({email:c.email,password:c.pass},function(a,c){if(a){switch(a.code){case"INVALID_PASSWORD":b.login.message="The password is incorrect.";break;case"INVALID_EMAIL":b.login.message="The specified email is not a valid email.";break;default:b.login.message=a}b.login.success=!1,d.reject()}else b.login.success=!0,b.login.message="",d.resolve()},{remember:"sessionOnly"}),b.promise=d.promise},b.message={regSuccess:null,text:""};var g=a.child("departments");g.on("value",function(a){for(var c in a.val()){var d=a.val();b.depts.push({id:c,name:d[c].name})}console.log("departments loaded")},function(a){console.log(a)});var h;b.register=function(c){var d=e.defer();g=a.child("tokens"),g.once("value",function(a){a=a.val();var e,g,i=!1;for(var j in a)if(e=a[j].token,g=a[j].used,c.token==e&&!g){console.log("token match"),i=!0,h=j,f(c);break}i||(console.log("token invalid"),b.message.text="Token Invalid",b.message.regSuccess=!1,d.reject())},function(a){console.log(a),d.reject()});var f=function(c){a.createUser({email:c.email,password:c.pass},function(a,e){if(a){switch(a.code){case"EMAIL_TAKEN":b.message.text="The new user account cannot be created because the email is already in use.";break;case"INVALID_EMAIL":b.message.text="The specified email is not a valid email.";break;default:b.message.text=a}b.message.regSuccess=!1,d.reject()}else console.log("Successfully created user account with uid:",e.uid),b.message.regSuccess=!0,b.message.text="Registration completed successfully!",b.login(c),d.resolve()})};b.regpromise=d.promise}}]),angular.module("bvcoeDmsApp").controller("DashboardCtrl",["$scope","FirebaseAuth","$location","$rootScope","$http",function(a,b,c,d,e){d.authData=b.$getAuth(),b.$onAuth(function(a){a?console.log("Logged in as:",a.uid):(console.log("Logged out"),c.path("/"))}),a.push=function(a){var b="40862591aa0d0abdcaa450c53fd513ab31369a39c56de17d",c="1bb897af",d=a.tokens.split(",");console.log(d);var f=btoa(b+":"),g={method:"POST",url:"https://push.ionic.io/api/v1/push",headers:{"Content-Type":"application/json","X-Ionic-Application-Id":c,Authorization:"basic "+f},data:{tokens:d,notification:{alert:a.body,title:a.title}}};e(g).success(function(a){console.log("Ionic Push: Push success!")}).error(function(a){console.log("Ionic Push: Push error...")})}}]),angular.module("bvcoeDmsApp").factory("FirebaseAuth",["$firebaseAuth","firebaseurl",function(a,b){var c=new Firebase(b);return a(c)}]),angular.module("bvcoeDmsApp").constant("firebaseurl","https://hazri.firebaseio.com"),angular.module("bvcoeDmsApp").directive("compareTo",function(){return{require:"ngModel",scope:{otherModelValue:"=compareTo"},link:function(a,b,c,d){d.$validators.compareTo=function(b){return b==a.otherModelValue},a.$watch("otherModelValue",function(){d.$validate()})}}}),angular.module("bvcoeDmsApp").factory("FirebaseRef",["firebaseurl",function(a){var b=new Firebase(a);return b}]),angular.module("bvcoeDmsApp").controller("DefaultersCtrl",["$scope","FirebaseRef","$q",function(a,b,c){a.depts=[],a.years=[{id:1,name:"First Year"},{id:2,name:"Second Year"},{id:3,name:"Third Year"},{id:4,name:"Final Year"}],a.form={};var d=c.defer();b.child("departments").once("value",function(b){for(var c in b.val()){var e=b.val();a.depts.push({id:c,name:e[c].name})}d.resolve()},function(a){console.log(a),d.reject()}),a.deptpromise=d.promise,a.defaulters=[],a.loadDefaulters=function(d){var e,f=d.dept;d.sem;switch(console.log(d),d.year){case"1":e="fe";break;case"2":e="se";break;case"3":e="te";break;case"4":e="be"}var g=c.defer();b.child("defaulters/"+f).once("value",function(b){var c=[];console.log(b.val());for(var d in b.val()){var e=d.split("-");c.push({dept:e[1].toUpperCase(),year:e[2].toUpperCase(),sem:e[3].substr(3),date:e[4]+"-"+e[5]+"-"+e[6],base64:b.val()[d].excel})}a.defaulters=c,g.resolve(),a.$apply()},function(a){console.log(a),g.reject()}),a.promise=g.promise},a.download=function(a){window.open(a,"somefile","width=600,height=300,resizable=1")}}]),angular.module("bvcoeDmsApp").factory("isNewUser",["FirebaseRef","$q",function(a,b){var c=function(c){var d=b.defer(),e=!0;return a.child("teachers").once("value",function(a){for(var b in a.val())for(var f in a.val())c.uid==f&&(e=!1);d.resolve(e)},function(a){console.log(a),d.reject()}),d.promise};return c}]),angular.module("bvcoeDmsApp").controller("DataentryCtrl",["$scope","XLSXReaderService","FirebaseRef","$q","$timeout",function(a,b,c,d,e){a.json_string="",a.isProcessing=!0;var f=[];a.fileChanged=function(c){a.excelFile=c[0],b.readFile(a.excelFile,!1,!0).then(function(b){f=b.sheets,a.isProcessing=!1,console.log(f)})},a.download=function(a){var a;c.child("defaulters/excelformat").once("value",function(b){a=b.val(),console.log(a),window.open(a,"","width=600,height=300,resizable=1")})},a.upload=function(){for(var b=d.defer(),g=f.info[0].dept,h=f.info[0].year,i=f.info[0].semester,j=f.info[0]["total students"],k=g+"-"+h,l={},m=1;6>m&&void 0!==f.info[0]["batch "+m+" starts with roll"];)l[m]=f.info[0]["batch "+m+" starts with roll"],m++;c.child("studentCount/"+g+"/"+k).update({batchno:l,count:j,dept:g,year:h},function(d){if(d)console.log(d);else for(var k=0;j>k;k++){var l=f.students[k].name,m=f.students[k].rollno,n=f.students[k].phone,o=f.students[k]["parents phone"],p=f.students[k].gender,q=f.students[k]["unique id"];c.child("students/"+g+"/"+q).update({name:l,phone:n,parents_phone:o,rollno:m,year:h,gender:p,uid:q},function(a){if(a)console.log(a);else for(var b=0;b<f.subjects.length;b++){for(var d=f.subjects[b].fullname,e=f.subjects[b]["short name"],j="yes"==f.subjects[b].theory,k="yes"==f.subjects[b].practical,l=f.subjects[b]["theory teacher"]||null,m=f.subjects[b]["subject code"],n={},o=1;5>o&&void 0!==f.subjects[b]["batch "+o+" teacher"];)n[o]=f.subjects[b]["batch "+o+" teacher"],o++;console.log(n),c.child("subjects/"+g+"/"+m).update({fullname:d,name:e,theory:j,practical:k,teacher:l,pteacher:n,dept_id:g,year:h,sem:i},function(a){if(a)console.log(a);else{var b=f.info[0]["dept name"],d=null;-1!=g.indexOf("-")&&(d=g.substr(g.length-1)),c.child("departments/"+g).update({name:b,div:d},function(a){a?console.log(a):console.log("success")})}})}})}e(function(){console.log("data upload successfull"),a.success="Data upload successfull",a.form.$setPristine(),b.resolve()},5e3)}),a.loading=b.promise}}]),function(a){if("undefined"==typeof XLSX)return void console.log("xlsx.js is required. Get it from https://github.com/SheetJS/js-xlsx");if("undefined"==typeof _)return void console.log("Lodash.js is required. Get it from http://lodash.com/");var b=this,c=(b.XLSXReader,function(a,b,d,e){var f={};return c.utils.intializeFromFile(f,a,b,d,e),f});"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.XLSXReader=c):b.XLSXReader=c,c.VERSION="0.0.1",c.utils={intializeFromFile:function(a,b,d,e,f){var g=new FileReader;g.onload=function(b){var g=b.target.result,h=XLSX.read(g,{type:"binary"});a.sheets=c.utils.parseWorkbook(h,d,e),f(a)},g.readAsBinaryString(b)},parseWorkbook:function(a,b,d){if(d===!0)return c.utils.to_json(a);var e={};return _.forEachRight(a.SheetNames,function(d){var f=a.Sheets[d];e[d]=c.utils.parseSheet(f,b)}),e},parseSheet:function(b,c){var d=XLSX.utils.decode_range(b["!ref"]),e=[];return c===!0&&_.forEachRight(_.range(d.s.r,d.e.r+1),function(c){var f=[];_.forEachRight(_.range(d.s.c,d.e.c+1),function(d){var e=XLSX.utils.encode_cell({c:d,r:c}),g=b[e];f[d]=g?g.v:a}),e[c]=f}),{data:e,name:b.name,col_size:d.e.c+1,row_size:d.e.r+1}},to_json:function(a){var b={};return a.SheetNames.forEach(function(c){var d=XLSX.utils.sheet_to_row_object_array(a.Sheets[c]);d.length>0&&(b[c]=d)}),b}}}.call(this),angular.module("bvcoeDmsApp").factory("XLSXReaderService",["$q","$rootScope",function(a,b){var c=function(a){angular.extec(this,a)};return c.readFile=function(c,d,e){var f=a.defer();return XLSXReader(c,d,e,function(a){b.$apply(function(){f.resolve(a)})}),f.promise},c}]),angular.module("bvcoeDmsApp").controller("AttendancesCtrl",["$rootScope","$scope","FirebaseRef","$q",function(a,b,c,d){b.attendances=[],console.log("test");var e=d.defer();c.child("attendances").once("value",function(c){var d=c.val();console.log(d);for(var f in d)for(var g in d[f])d[f][g].teacher==a.authData.uid&&(b.attendances[g]=d[f][g]);e.resolve(),b.$apply()},function(a){console.log(a),e.reject()}),b.promise=e.promise}]),angular.module("bvcoeDmsApp").controller("GendefaulterCtrl",["$scope","$http","$q",function(a,b,c){a.generate=function(d,e,f){var g=c.defer();b({method:"GET",url:"http://bvcoeportal.orgfree.com/defaulters/generate_defaulter_api.php/"+d+"/"+e+"/"+f}).then(function(a){g.resolve()},function(a){g.reject()}),a.promise=g.promise}}]),angular.module("bvcoeDmsApp").run(["$templateCache",function(a){a.put("views/attendances.html",'<div cg-busy="{promise:promise, message:\'Loading..\', backdrop:true}"></div> <table class="table table-striped"> <tr> <th>Sr. No</th> <th>Dept</th> <th>Sem</th> <th>Subject</th> <th>Absent Numbers</th> <th>Date</th> </tr> <tr ng-repeat="item in attendances track by $index"> <td>{{$index + 1}}</td> <td>{{item.dept}}</td> <td>{{item.semester}}</td> <td>{{item.subid}}</td> <td>{{item.absentno}}</td> <td style="min-width:100px">{{item.date}}</td> </tr> </table>'),a.put("views/dashboard.html",'<p>This is the dashboard view.</p> <div class="panel panel-default" ng-if="false"> <div class="panel-heading"> <h3 class="panel-title">Push Notifications</h3> </div> <div class="panel-body"> <form class="form-signin"> <div class="input-group"> <label for="title" class="sr-only">Title</label> <span class="input-group-addon"><span class="glyphicon glyphicon-envelope"></span></span> <input type="text" id="title" class="form-control" placeholder="Title" ng-model="notif.title" required autofocus> </div> <div class="input-group"> <label for="body" class="sr-only">Password</label> <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span> <input type="textarea" id="body" class="form-control" placeholder="Notification body" ng-model="notif.body" required> </div> <div class="input-group"> <label for="tokens" class="sr-only">Password</label> <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span> <input type="textarea" id="tokens" class="form-control" placeholder="tokens" ng-model="notif.tokens" required> </div> <button class="btn btn-primary btn-block" ng-click="push(notif)">Push</button> </form> </div> </div>'),a.put("views/dataentry.html",'<h4>Data Entry Form</h4> <form name="form" enctype="multipart/form-data" class="col-md-6"> <div class="form-group"> <div class="input-group"> <button class="btn btn-default" ng-click="download()">Please download excel format</button> </div> </div> <div class="form-group"> <div class="input-group"> <span class="input-group-addon" id="basic-addon3">Choose your excel file</span> <input class="form-control" type="file" id="excel_file" accept=".xlsx, .xls" onchange="angular.element(this).scope().fileChanged(this.files)"> </div> </div> <div class="alert alert-success" ng-show="!isProcessing"> Sheet Loaded </div> <div class="alert alert-success" ng-if="success">{{success}}</div> <button class="btn btn-info" ng-disabled="isProcessing" ng-click="upload()">Upload to database</button> <div cg-busy="{promise:loading, message:\'Uploading..\', backdrop:true}"></div> </form>'),a.put("views/defaulters.html",'<div class="row"> <div class="col-md-6"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title">View Defaulters</h3> </div> <div class="panel-body"> <form class="form-signin"> <div class="input-group"> <label for="inputDept" class="sr-only">Department</label> <span class="input-group-addon"><span class="glyphicon glyphicon-briefcase"></span></span> <select id="inputDept" class="form-control" ng-model="form.dept"> <option ng-repeat="dept in depts" value="{{dept.id}}">{{dept.name}}</option> </select> <div cg-busy="deptpromise"></div> </div> <div class="input-group"> <label for="inputYear" class="sr-only">Year</label> <span class="input-group-addon"><span class="glyphicon glyphicon-signal"></span></span> <select id="inputYear" class="form-control" ng-model="form.year"> <option ng-repeat="year in years" value="{{year.id}}">{{year.name}}</option> </select> </div> <div class="input-group"> <label for="inputSem" class="sr-only">Year</label> <span class="input-group-addon"><span class="glyphicon glyphicon-signal"></span></span> <select id="inputSem" class="form-control" ng-model="form.sem"> <option value="{{2 * form.year - 1}}">Semester {{2 * form.year - 1}}</option> <option value="{{2 * form.year}}">Semester {{2 * form.year}}</option> </select> </div> <button class="btn btn-primary btn-block" ng-click="loadDefaulters(form)">Go</button> <div cg-busy="{promise:promise, message:\'Loading in..\', backdrop:true}"></div> </form> </div> </div> </div> <div class="col-md-6" ng-show="defaulters.length>0"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title">Defaulters</h3> </div> <div class="panel-body"> <table class="table table-condensed"> <tr> <th>Name</th> <th>Date</th> <th>Link</th> </tr> <tr ng-repeat="item in defaulters"> <td>{{item.dept}} {{item.year}} Sem {{item.sem}}</td> <td>{{item.date | date:\'dd MMMM, yyyy\'}}</td> <td><a href="#/defaulters" ng-click="download(item.base64)">Download</a></td> </tr> </table> </div> </div> </div> </div>'),a.put("views/gendefaulter.html",'<div class="row" ng-if="$storage.userData.role == \'admin\'"> <div class="col-md-6"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title">Generate Defaulters for {{$storage.userData.dept}} {{$storage.userData.year}} {{$storage.userData.sem}}</h3> </div> <div class="panel-body"> <form class="form-signin"> <button class="btn btn-primary btn-block" ng-click="generate($storage.userData.dept,$storage.userData.year,$storage.userData.sem)">Go</button> <div cg-busy="{promise:promise, message:\'Loading ..\', backdrop:true}"></div> </form> </div> </div> </div> </div>'),a.put("views/main.html",'<div class="row"> <div class="col-md-6"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title">Teacher\'s Login</h3> </div> <div class="panel-body"> <form class="form-signin"> <div class="input-group"> <label for="inputEmail" class="sr-only">Email address</label> <span class="input-group-addon"><span class="glyphicon glyphicon-envelope"></span></span> <input type="email" id="inputEmail" class="form-control" placeholder="Email address" ng-model="user.email" required autofocus> </div> <div class="input-group"> <label for="inputPassword" class="sr-only">Password</label> <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span> <input type="password" id="inputPassword" class="form-control" placeholder="Password" ng-model="user.pass" required> </div> <button class="btn btn-primary btn-block" ng-click="login(user)">Sign in</button> <div cg-busy="{promise:promise, message:\'Signing in..\', backdrop:true}"></div> <div class="alert" ng-class="{\'alert-success\':login.success, \'alert-danger\':!login.success}" ng-show="login.message.length" style="margin-top: 1em" role="alert">{{login.message}}</div> </form> </div> </div> </div> <div class="col-md-6"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title">Teacher\'s Registration</h3> </div> <div class="panel-body"> <form class="form-signin" name="regform" ng-submit="register(reg)"> <div class="input-group" ng-class="{ \'has-error\' : regform.name.$invalid && !regform.name.$pristine }"> <label for="inputName" class="sr-only">Full Name</label> <span class="input-group-addon"><span class="glyphicon glyphicon-user"></span></span> <input type="text" id="inputName" name="name" class="form-control" placeholder="Full name" ng-model="reg.name" required> </div> <p ng-show="regform.name.$invalid && !regform.name.$pristine" class="help-block">Your name is required.</p> <div class="input-group"> <label for="inputDept" class="sr-only">Department</label> <span class="input-group-addon"><span class="glyphicon glyphicon-briefcase"></span></span> <select id="inputDept" class="form-control" ng-model="reg.dept"> <option ng-repeat="dept in depts" value="{{dept.id}}">{{dept.name}}</option> </select> </div> <div class="input-group" ng-class="{ \'has-error\' : regform.email.$invalid && !regform.email.$pristine }"> <label for="inputEmail" class="sr-only">Email address</label> <span class="input-group-addon"><span class="glyphicon glyphicon-envelope"></span></span> <input type="email" id="inputEmail" name="email" class="form-control" placeholder="Email address" ng-model="reg.email" required> </div> <p ng-show="regform.email.$invalid && !regform.email.$pristine" class="help-block">Email is invalid.</p> <div class="input-group" ng-class="{ \'has-error\' : regform.pass.$invalid && !regform.pass.$pristine }"> <label for="inputPassword" class="sr-only">Password</label> <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span> <input type="password" id="inputPassword" name="pass" class="form-control" placeholder="Password" minlength="6" ng-model="reg.pass" required> </div> <p ng-show="regform.pass.$invalid && !regform.pass.$pristine" class="help-block">Passwords min length should be 6</p> <div class="input-group" ng-class="{ \'has-error\' : regform.pass2.$invalid && !regform.pass2.$pristine }"> <label for="inputPassword2" class="sr-only">Confirm Password</label> <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span> <input type="password" id="inputPassword2" name="pass2" class="form-control" placeholder="Confirm password" minlength="6" ng-model="reg.pass2" required compare-to="reg.pass"> </div> <p ng-show="regform.pass2.$invalid && !regform.pass2.$pristine" class="help-block">Passwords must match</p> <div class="input-group"> <label for="inputToken" class="sr-only">Token</label> <span class="input-group-addon"><span class="glyphicon glyphicon-pencil"></span></span> <input type="text" id="inputToken" class="form-control" placeholder="Token" ng-model="reg.token" required> </div> <div class="input-group"> <label>Teacher Type:</label> <div class="radio"> <label> <input type="radio" name="teacherRole" value="admin" ng-model="reg.teacherrole">HOD/ClassAdvisor</label> <label> <input type="radio" name="teacherRole" value="" ng-model="reg.teacherrole">Normal</label> </div> </div> <button type="submit" class="btn btn-primary btn-block" ng-disabled="regform.$invalid">Register</button> <div cg-busy="regpromise"></div> <div class="alert" ng-class="{\'alert-success\':message.regSuccess, \'alert-danger\':!message.regSuccess}" ng-show="message.text !== \'\'" style="margin-top: 1em" role="alert">{{message.text}}</div> </form> </div> </div> </div> </div>'),a.put("views/takeAttendance.html",'<div> <style>#over {\n      background-image: url("images/android.5754a37f.jpg");\n      background-repeat: no-repeat;\n      height: 700px;\n      width: 408px;\n      position: relative;\n      left: 50%;\n      margin-left: -204px;\n    }\n    iframe {\n      position: relative;\n      left: 46px;\n      top: 56px;\n      height: 560px;\n      width: 316px;\n    }</style> <div id="over"> <iframe src="web/index.html" frameborder="0"></iframe> </div> </div>')}]);